import{_ as t,e as a,f as i,o as l}from"./app-fvSY76QE.js";const o={};function n(r,e){return l(),a("div",null,e[0]||(e[0]=[i('<h2 id="bgp的四种报文" tabindex="-1"><a class="header-anchor" href="#bgp的四种报文"><span>BGP的四种报文</span></a></h2><ol><li><strong>open message</strong>： <ul><li>在TCP连接建立后产生</li><li>用于协商邻居建立的关键参数（as number,hold time,router ID）</li><li>hold time以比较小的一方数值为准</li><li>router ID选择方式与OSPF一致</li><li>修改router ID会重置邻居关系</li></ul></li><li><strong>keepalive message</strong>： <ul><li>相当于IGP协议的hello报文</li><li>在open之后产生，用作心跳，确保邻居关系的存在</li><li>消息本身不携带任何参数，依靠IP包头内源地址确认邻居</li><li>默认频率60s，若180s内没有收到下一个keepalive，则认为邻居无效</li><li>keepalive发送频率为协商后的hold time/3</li><li>keepalive可能与open合为一个message发送</li></ul></li><li><strong>update message</strong>： <ul><li>用于在邻居之间交互路由信息</li><li>该消息采用触发更新和增量更新的方式发送</li><li>包含路径的路由前缀以及该路由携带的attribute</li><li>按照共性的方式进行排列（将attribute完全相同的归为一组）</li><li>一条update可以只通告一条路由，携带多个属性</li><li>一条update也可以通告多条路由，但是属性必须一致</li><li>一条update可以同时撤销多条路由</li></ul></li><li><strong>notification</strong>： <ul><li>用于向邻居发送一些错误通告（例：hello time无法协商或者超时、AS号不匹配）</li></ul></li></ol><h2 id="状态机" tabindex="-1"><a class="header-anchor" href="#状态机"><span>状态机</span></a></h2><ol><li><strong>Idle（空闲）</strong>： <ul><li>空闲状态，BGP 邻居初始化状态.</li><li>如果neighbor 指定的为 EBGP 邻居，则启动直连检测，检测失败保持 Idle状态，如果检测成功则进入 Active 状态，开始尝试TCP 连接</li><li>如果 neighbor 指定的为 iBGP 邻居，则直接开始查询路由表，无论是否存在路由都转换状态为 Active, 准备尝试 TCP 连接。</li></ul></li><li><strong>Active（激活）</strong>： <ul><li>活动状态，开始进行 TCP 连接建立</li><li>启用随机延时，确保两边不会同时开始 TCP 会话</li><li>如果查不到去往邻居的路由，并作为主动连接方，则继续保持该状态，每30秒重新检测一次路由条目。</li><li>如果查不到去往邻居的路由，并作为被动连接方，则继续保特该状态，等待对方发起的 TCP 连接。</li><li>如果存在去往邻居的路由，并作为主动连接方，但是收不到对方回应，则继续保持该状态，每30 秒尝试一次重新连接。</li><li>如果存在去往邻居的路由，但是作为被动连按方，并且收到了对方产生的TCP 连接，则退回到ldle， 并立即进入 Connect 状态。</li><li>如果 TCP 连接成功，则立即进入 Open sent 抉态，并开始协商，如果协商失败则退回到ldle， 并重新进入Active 状态，开始循环。</li></ul></li><li><strong>Connect（连接）</strong>： <ul><li>连接状态，被动等待 TCP 连接的完成。</li><li>如果 TCP 连接建主成功则直接进入 Open sent 次态</li><li>如果 TCP 连接失败，则进入 Active 状态，尝试重新建立 TCP 连接</li><li>Connect 状态一定要从ldle 状态进入</li></ul></li><li><strong>OpenSent（已发送Open消息）</strong>： <ul><li>打开发送，双方进行参数协商，也就是产生 Open Message</li><li>如果 Open Message 协商成功，则进入到 Open confirm 状态</li><li>如果 Open Message 协商失败，则产生 Notification Message 并退回到 idle.</li></ul></li><li><strong>OpenConfirm（已确认Open消息）</strong>： <ul><li>打开确认，协商取得一致</li><li>如果从对等体收到了 Keepalive，则进入 Establish 状态</li></ul></li><li><strong>Established（已建立）</strong>： <ul><li>邻居建立成功</li><li>BGP将开始通过update message交互路由信息</li></ul></li></ol><h2 id="停留在不同状态原因" tabindex="-1"><a class="header-anchor" href="#停留在不同状态原因"><span>停留在不同状态原因</span></a></h2><h3 id="如果一直停留在-ldle-状态-则可能" tabindex="-1"><a class="header-anchor" href="#如果一直停留在-ldle-状态-则可能"><span>如果一直停留在 ldle 状态，则可能：</span></a></h3><ul><li>EBGP 直连检测没有通过。</li><li>因为某些 BGP Feature 导致的连接被限制。例如：maximum-prefix</li></ul><h3 id="如果一直停留在-active-状态-则可能" tabindex="-1"><a class="header-anchor" href="#如果一直停留在-active-状态-则可能"><span>如果一直停留在 Active 状态，则可能：</span></a></h3><ul><li>没有去往邻居的路由</li><li>邻居没有回包路曲</li><li>邻居没有neighbor 指令</li><li>邻居neighbor 指令中地址错误</li><li>两端 AS number 不匹配</li><li>两端Authentication 不通过</li></ul><h2 id="选路原则" tabindex="-1"><a class="header-anchor" href="#选路原则"><span>选路原则</span></a></h2><p>1、优选具有最高weight值的路径 2、具有较高local preference的路径优先（AS内传递） 3、优选本地始发的路由 4、优选AS path最短的路径 5、根据origin code的顺序（i&gt;e&gt;?） 6、优选MED（metric）最小的路径 7、ebgp优于ibgp 8、优选bgp next hop的igp开销最小的路径</p>',11)]))}const c=t(o,[["render",n],["__file","index.html.vue"]]),m=JSON.parse('{"path":"/network/8e95wget/","title":"bgp","lang":"zh-CN","frontmatter":{"title":"bgp","createTime":"2025/04/17 09:10:20","permalink":"/network/8e95wget/","description":"BGP的四种报文 open message： 在TCP连接建立后产生 用于协商邻居建立的关键参数（as number,hold time,router ID） hold time以比较小的一方数值为准 router ID选择方式与OSPF一致 修改router ID会重置邻居关系 keepalive message： 相当于IGP协议的hello报文 ...","head":[["meta",{"property":"og:url","content":"http://git.x-echo.net/network/8e95wget/"}],["meta",{"property":"og:site_name","content":"谈呀"}],["meta",{"property":"og:title","content":"bgp"}],["meta",{"property":"og:description","content":"BGP的四种报文 open message： 在TCP连接建立后产生 用于协商邻居建立的关键参数（as number,hold time,router ID） hold time以比较小的一方数值为准 router ID选择方式与OSPF一致 修改router ID会重置邻居关系 keepalive message： 相当于IGP协议的hello报文 ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-03-17T03:56:27.000Z"}],["meta",{"property":"article:modified_time","content":"2025-03-17T03:56:27.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"bgp\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-03-17T03:56:27.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":3.63,"words":1090},"git":{"updatedTime":1742183787000,"contributors":[{"name":"wyutan","username":"wyutan","email":"90786339+wyutan@users.noreply.github.com","commits":7,"avatar":"https://avatars.githubusercontent.com/wyutan?v=4","url":"https://github.com/wyutan"}],"changelog":[{"hash":"21c64a4309790e84e117ebe920a757e26fd0bcff","date":1740042688000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"Add files via upload","commitUrl":"https://github.com/wyutan/tanya//commit/21c64a4309790e84e117ebe920a757e26fd0bcff"},{"hash":"7780a57d8dcdd55327da296f1070c1a96a01b999","date":1740109154000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"Update bgp.md","commitUrl":"https://github.com/wyutan/tanya//commit/7780a57d8dcdd55327da296f1070c1a96a01b999"},{"hash":"afa12cced6a9e7714c61ff088b7b762b6052a59a","date":1740410696000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"Rename bgp.md to 2.bgp.md","commitUrl":"https://github.com/wyutan/tanya//commit/afa12cced6a9e7714c61ff088b7b762b6052a59a"},{"hash":"3ae14fee0e195d482f9e9e2d7320f339a19372f1","date":1741958714000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"更新 2.bgp.md","commitUrl":"https://github.com/wyutan/tanya//commit/3ae14fee0e195d482f9e9e2d7320f339a19372f1"},{"hash":"e63d6b6e31a5239da8565f8b3b658a1f83a346c6","date":1741958875000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"更新 2.bgp.md","commitUrl":"https://github.com/wyutan/tanya//commit/e63d6b6e31a5239da8565f8b3b658a1f83a346c6"},{"hash":"c0dec07484783cf25d089a51cec9e47a6780429a","date":1742183224000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"Update 2.bgp.md","commitUrl":"https://github.com/wyutan/tanya//commit/c0dec07484783cf25d089a51cec9e47a6780429a"},{"hash":"3e651fdf26be6b9f3134d0a7251909ca2f56125f","date":1742183787000,"email":"90786339+wyutan@users.noreply.github.com","author":"wyutan","message":"Update 2.bgp.md","commitUrl":"https://github.com/wyutan/tanya//commit/3e651fdf26be6b9f3134d0a7251909ca2f56125f"}]},"autoDesc":true,"filePathRelative":"network/protocol/2.bgp.md"}');export{c as comp,m as data};
